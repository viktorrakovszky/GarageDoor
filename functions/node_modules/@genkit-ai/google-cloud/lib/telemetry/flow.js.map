{"version":3,"sources":["../../src/telemetry/flow.ts"],"sourcesContent":["/**\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { GENKIT_VERSION } from '@genkit-ai/core';\nimport { logger } from '@genkit-ai/core/logging';\nimport { PathMetadata, toDisplayPath } from '@genkit-ai/core/tracing';\nimport { ValueType } from '@opentelemetry/api';\nimport { hrTimeDuration, hrTimeToMilliseconds } from '@opentelemetry/core';\nimport { ReadableSpan } from '@opentelemetry/sdk-trace-base';\nimport {\n  MetricCounter,\n  MetricHistogram,\n  Telemetry,\n  internalMetricNamespaceWrap,\n} from '../metrics';\nimport {\n  createCommonLogAttributes,\n  extractErrorMessage,\n  extractErrorName,\n  extractErrorStack,\n} from '../utils';\n\nclass FlowsTelemetry implements Telemetry {\n  /**\n   * Wraps the declared metrics in a Genkit-specific, internal namespace.\n   */\n  private _N = internalMetricNamespaceWrap.bind(null, 'flow');\n\n  private flowCounter = new MetricCounter(this._N('requests'), {\n    description: 'Counts calls to genkit flows.',\n    valueType: ValueType.INT,\n  });\n\n  private pathCounter = new MetricCounter(this._N('path/requests'), {\n    description: 'Tracks unique flow paths per flow.',\n    valueType: ValueType.INT,\n  });\n\n  private pathLatencies = new MetricHistogram(this._N('path/latency'), {\n    description: 'Latencies per flow path.',\n    ValueType: ValueType.DOUBLE,\n    unit: 'ms',\n  });\n\n  private flowLatencies = new MetricHistogram(this._N('latency'), {\n    description: 'Latencies when calling Genkit flows.',\n    valueType: ValueType.DOUBLE,\n    unit: 'ms',\n  });\n\n  tick(\n    span: ReadableSpan,\n    paths: Set<PathMetadata>,\n    logIO: boolean,\n    projectId?: string\n  ): void {\n    const attributes = span.attributes;\n    const name = attributes['genkit:name'] as string;\n    const path = attributes['genkit:path'] as string;\n    const latencyMs = hrTimeToMilliseconds(\n      hrTimeDuration(span.startTime, span.endTime)\n    );\n    const isRoot = (attributes['genkit:isRoot'] as boolean) || false;\n    const state = attributes['genkit:state'] as string;\n\n    const input = attributes['genkit:input'] as string;\n    const output = attributes['genkit:output'] as string;\n\n    if (input && logIO) {\n      this.recordIO(span, 'Input', name, path, input, projectId);\n    }\n\n    if (output && logIO) {\n      this.recordIO(span, 'Output', name, path, output, projectId);\n    }\n\n    if (state === 'success') {\n      this.writeFlowSuccess(\n        span,\n        paths!,\n        name,\n        path,\n        latencyMs,\n        isRoot,\n        projectId\n      );\n      return;\n    }\n\n    if (state === 'error') {\n      const errorName = extractErrorName(span.events) || '<unknown>';\n      const errorMessage = extractErrorMessage(span.events) || '<unknown>';\n      const errorStack = extractErrorStack(span.events) || '';\n\n      this.writeFlowFailure(\n        span,\n        paths!,\n        name,\n        path,\n        latencyMs,\n        errorName,\n        isRoot,\n        projectId\n      );\n      this.recordError(\n        span,\n        path,\n        errorName,\n        errorMessage,\n        errorStack,\n        projectId\n      );\n      return;\n    }\n\n    logger.warn(`Unknown flow state; ${state}`);\n  }\n\n  private recordIO(\n    span: ReadableSpan,\n    tag: string,\n    flowName: string,\n    qualifiedPath: string,\n    input: string,\n    projectId?: string\n  ) {\n    const path = toDisplayPath(qualifiedPath);\n    const sharedMetadata = {\n      ...createCommonLogAttributes(span, projectId),\n      path,\n      qualifiedPath,\n      flowName,\n    };\n    logger.logStructured(`${tag}[${path}, ${flowName}]`, {\n      ...sharedMetadata,\n      content: input,\n    });\n  }\n\n  private recordError(\n    span: ReadableSpan,\n    path: string,\n    errorName: string,\n    errorMessage: string,\n    errorStack: string,\n    projectId?: string\n  ) {\n    const displayPath = toDisplayPath(path);\n    logger.logStructuredError(`Error[${displayPath}, ${errorName}]`, {\n      ...createCommonLogAttributes(span, projectId),\n      path: displayPath,\n      qualifiedPath: path,\n      name: errorName,\n      message: errorMessage,\n      stack: errorStack,\n      source: 'ts',\n      sourceVersion: GENKIT_VERSION,\n    });\n  }\n\n  private writeFlowSuccess(\n    span: ReadableSpan,\n    paths: Set<PathMetadata>,\n    flowName: string,\n    path: string,\n    latencyMs: number,\n    isRoot: boolean,\n    projectId?: string\n  ) {\n    const dimensions = {\n      name: flowName,\n      status: 'success',\n      source: 'ts',\n      sourceVersion: GENKIT_VERSION,\n    };\n    this.flowCounter.add(1, dimensions);\n    this.flowLatencies.record(latencyMs, dimensions);\n\n    if (isRoot) {\n      this.writePathMetrics(\n        span,\n        path,\n        paths,\n        flowName,\n        latencyMs,\n        undefined,\n        projectId\n      );\n    }\n  }\n\n  private writeFlowFailure(\n    span: ReadableSpan,\n    paths: Set<PathMetadata>,\n    flowName: string,\n    path: string,\n    latencyMs: number,\n    errorName: string,\n    isRoot: boolean,\n    projectId?: string\n  ) {\n    const dimensions = {\n      name: flowName,\n      status: 'failure',\n      source: 'ts',\n      sourceVersion: GENKIT_VERSION,\n      error: errorName,\n    };\n    this.flowCounter.add(1, dimensions);\n    this.flowLatencies.record(latencyMs, dimensions);\n\n    if (isRoot) {\n      this.writePathMetrics(\n        span,\n        path,\n        paths,\n        flowName,\n        latencyMs,\n        errorName,\n        projectId\n      );\n    }\n  }\n\n  /** Writes all path-level metrics stored in the current flow execution. */\n  private writePathMetrics(\n    span: ReadableSpan,\n    rootPath: string,\n    paths: Set<PathMetadata>,\n    flowName: string,\n    latencyMs: number,\n    err?: string,\n    projectId?: string\n  ) {\n    const flowPaths = Array.from(paths).filter((meta) =>\n      meta.path.includes(flowName)\n    );\n\n    if (flowPaths) {\n      logger.logStructured(`Paths[${flowName}]`, {\n        ...createCommonLogAttributes(span, projectId),\n        flowName: flowName,\n        paths: flowPaths.map((p) => toDisplayPath(p.path)),\n      });\n\n      flowPaths.forEach((p) => this.writePathMetric(flowName, p));\n      // If we're writing a failure, but none of the stored paths have failed,\n      // this means the root flow threw the error.\n      if (err && !flowPaths.some((p) => p.status === 'failure')) {\n        this.writePathMetric(flowName, {\n          status: 'failure',\n          path: rootPath,\n          error: err,\n          latency: latencyMs,\n        });\n      }\n    }\n  }\n\n  /** Writes metrics for a single PathMetadata */\n  private writePathMetric(flowName: string, meta: PathMetadata) {\n    const pathDimensions = {\n      flowName: flowName,\n      status: meta.status,\n      error: meta.error,\n      path: meta.path,\n      source: 'ts',\n      sourceVersion: GENKIT_VERSION,\n    };\n    this.pathCounter.add(1, pathDimensions);\n    this.pathLatencies.record(meta.latency, pathDimensions);\n  }\n}\n\nconst flowsTelemetry = new FlowsTelemetry();\nexport { flowsTelemetry };\n"],"mappings":"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","names":["import_core"]}